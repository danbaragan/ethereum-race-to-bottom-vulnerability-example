pragma solidity ^0.4.15;

// This is just a simple example of a coin-like contract.
// It is not standards compatible and cannot be expected to talk to other
// coin/token contracts. If you want to create a standards-compliant
// token, see: https://github.com/ConsenSys/Tokens. Cheers!

contract VulnerableCoin {
    event Log(
        string theContract,
        string theFunction,
        string message,
        uint256 value
    );

    mapping(address => uint256) public balanceOf;
    uint256 public totalSupply;

    function buy() payable {
        require(msg.value > 0);
        balanceOf[msg.sender] += msg.value;
    }

    function withdraw() {
        uint256 amount = balanceOf[msg.sender];
        Log("MC", "withdraw", "pay amount: ", amount);
        // 1. We are using low level call rather than send()/transfer()
        if (!(msg.sender.call.value(amount)())) revert();
        Log("MC", "withdraw", "clear balance: ", balanceOf[msg.sender]);
        // 2. We are not doing external calls last
        balanceOf[msg.sender] = 0;
    }

    function withdrawExternalLast() {
        uint256 amount = balanceOf[msg.sender];
        balanceOf[msg.sender] = 0;
        // 1. We are using low level call rather than send()/transfer()
        // but having the externals last saves us.
        // Evil2 (that calls this) will successfully withdraw only his share
        if (!(msg.sender.call.value(amount)())) revert();
    }

    function withdrawHighLevelCall() {
        uint256 amount = balanceOf[msg.sender];
        msg.sender.transfer(amount);
        // 2. We are not doing external calls last, but high level withdraw saves us due to out of gas
        // Evil3 (that calls this) will not be able to withdraw at all
        balanceOf[msg.sender] = 0;
    }

}
